<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/wiki/styles.ac3b29b64c5a015d68ef.css" id="gatsby-global-css">.popover{position:relative;max-width:16rem;box-shadow:0 10px 15px -3px var(--shadow),0 4px 6px -2px rgba(0,0,0,.05);padding:1rem;border:1px solid var(--separator);border-radius:.5rem;background-color:var(--references-bg);max-height:16rem;overflow:hidden}.popover.no-max-width{max-width:90vw}.popover.with-markdown{font-size:.875rem}.popover h1{margin:0;padding:0;font-size:1rem}.popover ul{padding-left:1rem}.popover .more-content-blind{height:4rem;position:absolute;background:transparent;background:linear-gradient(0,var(--references-bg),var(--references-bg-80) 50%,var(--references-bg-0));top:12rem;width:100%;left:0}.tippy-box[data-animation=shift-away][data-state=hidden]{opacity:0}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=top]{-webkit-transform:translateY(10px);transform:translateY(10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=bottom]{-webkit-transform:translateY(-10px);transform:translateY(-10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=left]{-webkit-transform:translateX(10px);transform:translateX(10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=right]{-webkit-transform:translateX(-10px);transform:translateX(-10px)}.reference{text-decoration:none}.reference:hover{color:var(--references-highlight)}.reference>div{padding-top:.5rem;padding-bottom:.5rem}.reference>div>p{margin:0;font-size:.875rem}.reference>div>ul{margin:0}.references-block{color:var(--references-text);padding:1rem;margin:1rem 0;border-radius:.5rem;background-color:var(--references-bg);transition:background-color .3s ease,color .3s ease}.references-block>div{margin-bottom:1rem}.references-block>hr{margin-left:auto;margin-right:auto;width:8rem}.references-block a{color:var(--references-text);transition:color .3s ease}.references-block>p:last-child{margin-bottom:0}.note-container{background:var(--note-bg);transition:background .3s ease}.note-container:first-child{border-left:none}.note-container .note-content,.note-container .obstructed-label{transition:opacity 75ms linear}.note-container .obstructed-label{display:block;color:var(--text);text-decoration:none;font-size:17px;line-height:40px;font-weight:500;-webkit-writing-mode:vertical-lr;-ms-writing-mode:tb-lr;writing-mode:vertical-lr;-webkit-text-orientation:sideways;text-orientation:sideways;margin-top:36px;top:0;bottom:0;left:0;position:absolute;background-color:transparent;width:40px;overflow:hidden;opacity:0;transition:color .3s ease;pointer-events:none}.note-container.note-container-highlighted{background:var(--references-bg);transition:background .3s ease}.note-content img{max-width:100%}@media screen and (max-width:800px){.note-container{padding:16px;width:100%;overflow-y:auto}}@media screen and (min-width:801px){.note-container{transition:box-shadow .1s linear,opacity 75ms linear,-webkit-transform .2s cubic-bezier(.19,1,.22,1);transition:box-shadow .1s linear,opacity 75ms linear,transform .2s cubic-bezier(.19,1,.22,1);transition:box-shadow .1s linear,opacity 75ms linear,transform .2s cubic-bezier(.19,1,.22,1),-webkit-transform .2s cubic-bezier(.19,1,.22,1);flex-shrink:0;width:625px;max-width:625px;top:0;position:-webkit-sticky;position:sticky;flex-grow:1;border-left:1px solid var(--separator);padding:0}.note-content{overflow-y:auto;height:100%;padding:32px}.note-container-overlay{box-shadow:0 0 15px 3px var(--shadow)}.note-container-obstructed .note-content{opacity:0}.note-container-obstructed .obstructed-label{opacity:1;pointer-events:all}}.dark-mode-toggle{cursor:pointer;-webkit-transform:scale(.6);transform:scale(.6)}.dark-mode-toggle input{display:none}.dark-mode-toggle input+div{border-radius:50%;width:36px;height:36px;position:relative;box-shadow:inset 16px -16px 0 0 #fff;-webkit-transform:scale(1) rotate(-2deg);transform:scale(1) rotate(-2deg);transition:box-shadow .5s ease 0s,-webkit-transform .4s ease .1s;transition:box-shadow .5s ease 0s,transform .4s ease .1s;transition:box-shadow .5s ease 0s,transform .4s ease .1s,-webkit-transform .4s ease .1s}.dark-mode-toggle input+div:before{content:"";width:inherit;height:inherit;border-radius:inherit;position:absolute;left:0;top:0;transition:background .3s ease}.dark-mode-toggle input+div:after{content:"";width:8px;height:8px;border-radius:50%;margin:-4px 0 0 -4px;position:absolute;top:50%;left:50%;box-shadow:0 -23px 0 var(--link),0 23px 0 var(--link),23px 0 0 var(--link),-23px 0 0 var(--link),15px 15px 0 var(--link),-15px 15px 0 var(--link),15px -15px 0 var(--link),-15px -15px 0 var(--link);-webkit-transform:scale(0);transform:scale(0);transition:all .3s ease}.dark-mode-toggle input:checked+div{box-shadow:inset 32px -32px 0 0 #fff;-webkit-transform:scale(.5) rotate(0deg);transform:scale(.5) rotate(0deg);transition:box-shadow .2s ease 0s,-webkit-transform .3s ease .1s;transition:transform .3s ease .1s,box-shadow .2s ease 0s;transition:transform .3s ease .1s,box-shadow .2s ease 0s,-webkit-transform .3s ease .1s}.dark-mode-toggle input:checked+:before{background:var(--link);transition:background .3s ease .1s}.dark-mode-toggle input:checked+:after{-webkit-transform:scale(1.5);transform:scale(1.5);transition:-webkit-transform .5s ease .15s;transition:transform .5s ease .15s;transition:transform .5s ease .15s,-webkit-transform .5s ease .15s}.graph-button{border:0;background:none;cursor:pointer}.graph-button svg g{stroke:var(--link)}.searchWrapper{position:relative;display:block}.inputWrapper{position:relative;color:var(--text)}.inputWrapper .searchIcon{position:absolute;fill:var(--link);left:2px;height:34px;padding:2px 2px 0;pointer-events:none}.inputWrapper input{color:var(--text);font-size:1rem;border:none;height:36px;padding-left:28px;background-color:var(--note-bg);transition:all .3s ease-in-out;width:28px}.inputWrapper input:focus{outline:none;width:100%}.results{-webkit-padding-start:0;padding-inline-start:0;position:absolute;display:block;top:100%;right:0;width:500px;max-height:50vh;background:var(--note-bg);box-shadow:-5px -5px 15px -3px var(--shadow),0 4px 6px -2px rgba(0,0,0,.05);overflow-y:auto;border-radius:8px}.results li{display:block;text-decoration:none;cursor:pointer;padding:16px 24px;border-bottom:1px solid var(--separator)}.results li:hover{background:var(--references-bg)}.results li .title{color:var(--text)}.results li .excerpt{color:var(--references-text)}@media screen and (max-width:600px){.results{right:-85px;width:calc(100vw - 40px)}}.lds-dual-ring:after{content:" ";left:calc(50% - 32px);position:relative;display:block;width:64px;height:64px;margin:8px;border-radius:50%;border-color:var(--separator);border-left:6px solid transparent;border-bottom:6px solid var(--separator);border-right:6px solid transparent;border-top:6px solid var(--separator);-webkit-animation:lds-dual-ring 1.2s ease-in-out infinite;animation:lds-dual-ring 1.2s ease-in-out infinite}@-webkit-keyframes lds-dual-ring{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}@keyframes lds-dual-ring{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}header{width:100%;min-height:57px;z-index:5;background-color:var(--note-bg);border-bottom:1px solid var(--separator);display:flex;justify-content:space-between;align-items:center;padding:10px 32px;flex-wrap:wrap;transition:background-color .3s ease}header>a{font-weight:700;color:var(--text);text-decoration:none;transition:color .3s ease}header .controls{display:flex}html{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body.light-mode{--main-bg:#fafafc;--note-bg:#fff;--text:#1a202c;--separator:#e2e8f0;--shadow:rgba(0,0,0,0.1);--link:#3182ce;--references-bg:#ebf4ff;--references-bg-80:rgba(235,244,255,0.8);--references-bg-0:rgba(235,244,255,0);--references-text:#718096;--references-highlight:#4a5568}body.dark-mode{--main-bg:#000;--note-bg:#0a0d11;--text:#fafafc;--separator:#252525;--shadow:hsla(0,0%,100%,0.1);--link:#3da1ff;--references-bg:#17181a;--references-bg-80:rgba(23,24,26,0.8);--references-bg-0:rgba(23,24,26,0);--references-text:#8c9fbb;--references-highlight:#b3cbf0}body{background-color:var(--main-bg);color:var(--text);margin:0;padding:0;height:100vh;transition:background-color .3s ease,color .3s ease}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}*,:after,:before{box-sizing:border-box}h1,h2,h3{font-weight:700}hr{margin-top:1rem;margin-bottom:1rem;border:solid var(--separator);border-width:1px 0 0;box-sizing:content-box;height:0;overflow:visible}a{color:var(--link);text-decoration:underline;transition:color .3s ease}a:hover{text-decoration:none}h1{font-size:1.875rem;margin-top:1rem}h1,p{margin-bottom:1rem}.layout{height:100vh;display:flex;flex-direction:column}.note-columns-scrolling-container{display:flex;overflow-x:auto;overflow-y:hidden;flex-grow:1}.note-columns-container{display:flex;flex-grow:1;transition:width .1s cubic-bezier(.19,1,.22,1)}@media screen and (max-width:800px){.note-columns-container{width:unset!important}}.overlay{z-index:98;position:fixed;top:0;right:0;bottom:0;left:0;display:flex;align-items:center;justify-content:center;height:100%;width:100%;background-color:var(--shadow);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.modal{z-index:99;position:fixed;border-radius:8px;background-color:var(--main-bg);box-shadow:-5px -5px 15px -3px var(--shadow),0 4px 6px -2px rgba(0,0,0,.05)}.modal-close,.modal-scale{position:absolute;top:0;right:0;padding:5px;border:0;background:none;color:var(--text);cursor:pointer}.modal-close svg,.modal-scale svg{width:20px;height:20px}.modal-close path,.modal-scale path{fill:currentColor}.modal-scale{right:30px}.modal-minimized .modal-close svg,.modal-minimized .modal-scale svg{width:15px;height:15px}.modal-minimized .modal-scale{right:25px}.modal-body{height:100%;width:100%}.modal-body .node,.modal-body .text{cursor:pointer}</style><meta name="generator" content="Gatsby 2.32.13"/><link as="script" rel="preload" href="/wiki/webpack-runtime-41aed87232eba2c85fde.js"/><link as="script" rel="preload" href="/wiki/framework-1ad0fed3c21e97f84900.js"/><link as="script" rel="preload" href="/wiki/app-7c974186bb8a4de4930e.js"/><link as="script" rel="preload" href="/wiki/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/wiki/component---node-modules-gatsby-theme-garden-src-templates-local-file-js-1c8fd98b48ff9516a3fc.js"/><link as="fetch" rel="preload" href="/wiki/page-data/Code Diary/Scheduled Backups on Ubuntu using Duplicacy and Azure/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/wiki/page-data/sq/d/2098632890.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/wiki/page-data/sq/d/2221750479.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/wiki/page-data/sq/d/2468095761.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/wiki/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout"><header><a href="/wiki/"><h3>Rudy&#x27;s Notes</h3></a><div class="controls"><div class="searchWrapper" role="combobox" aria-expanded="false" aria-haspopup="listbox" aria-labelledby="downshift-23-label"><div class="inputWrapper"><svg class="searchIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M23.111 20.058l-4.977-4.977c.965-1.52 1.523-3.322 1.523-5.251 0-5.42-4.409-9.83-9.829-9.83-5.42 0-9.828 4.41-9.828 9.83s4.408 9.83 9.829 9.83c1.834 0 3.552-.505 5.022-1.383l5.021 5.021c2.144 2.141 5.384-1.096 3.239-3.24zm-20.064-10.228c0-3.739 3.043-6.782 6.782-6.782s6.782 3.042 6.782 6.782-3.043 6.782-6.782 6.782-6.782-3.043-6.782-6.782z"></path></svg><input type="text" aria-autocomplete="list" aria-labelledby="downshift-23-label" autoComplete="off" value="" id="downshift-23-input" placeholder="Search..."/></div></div><button title="Show Graph visualisation" aria-label="Show Graph visualisation" class="graph-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20"><g fill="none" stroke-width="2"><circle cx="11.733" cy="3.181" r="1.902"></circle><circle cx="16.864" cy="10.861" r="1.902"></circle><circle cx="7.47" cy="16.822" r="1.902"></circle><circle cx="3.046" cy="6.275" r="1.902"></circle><circle cx="9.372" cy="10.861" r="1.902"></circle><line x1="11.635" x2="14.655" y1="10.861" y2="10.861"></line><line x1="10" x2="10.895" y1="8.959" y2="5.573"></line><line x1="7.47" x2="4.5" y1="9.68" y2="7.5"></line><line x1="8.25" x2="8.809" y1="14.92" y2="13.088"></line></g></svg></button><label class="dark-mode-toggle" aria-label="Activate dark mode" title="Activate dark mode"><input type="checkbox" checked=""/><div></div></label></div></header><div class="note-columns-scrolling-container"><div class="note-columns-container" style="width:1250px"><div class="note-container   " style="left:0;right:-585px"><div class="note-content"><h1 id="scheduled-backups-on-ubuntu-using-duplicacy-and-azure">Scheduled Backups on Ubuntu using Duplicacy and Azure</h1><p>This page is a guide on how to backup a folder on an Ubuntu machine to a storage account on Azure, using <a target="_blank" rel="noopener noreferrer" href="https://github.com/gilbertchen/duplicacy">Duplicacy</a>. The data backed up to Azure will be encrypted with an RSA key, and the config encrypted with a password. The backups will be scheduled via cronjob, and will send an email to you on every run (this requires an SMTP server, <a target="_blank" rel="noopener noreferrer" href="https://sendgrid.com/">SendGrid</a> is a decent option). This assumes you already have a machine setup.</p><h2 id="1-create-a-storage-account">1. Create a Storage Account</h2><ol><li>Go to the <a target="_blank" rel="noopener noreferrer" href="https://portal.azure.com/">Azure Portal</a> and make a new storage account, doesn&#x27;t matter the name/region/resource group etc. Feel free to use Azure&#x27;s redundancy features for extra backup security (assuming you trust Azure to not go down, which is a fairly safe assumption).</li><li>Create a container within the storage account, and form the URL <code>azure://STORAGEACCOUNT/CONTAINER</code> and save this for later.</li><li>Get one of the access keys and save it for later.</li></ol><h2 id="2-setup-duplicacy">2. Setup duplicacy</h2><ol><li>Grab the <a target="_blank" rel="noopener noreferrer" href="https://github.com/gilbertchen/duplicacy/releases">latest release</a> of duplicacy, make it executable with <code>chmod +x</code> and then move it into <code>/usr/local/bin</code>.</li><li>Go into the folder you want to backup and run <code>duplicacy init -e -key public.pem repository_id storage_url</code>.<ol><li><code>public.pem</code> can be any public RSA key.</li><li><code>repository_id</code> is just the name of the backup repository, choose whatever you like but remember it, as you&#x27;ll need it if you ever want to pull down the backup onto another machine.</li><li><code>storage_url</code> is the URL formed in step 1.2.</li><li>When you run this command, it will ask for a password because of the <code>-e</code> flag, this encrypts the config, so don&#x27;t lose this password. It will also ask for the access key to the storage account.</li></ol></li><li>Now you can run <code>duplicacy backup -stats</code> to do a backup. It will ask for the storage account access key and config password again. To prevent having to enter these every time, edit <code>.duplicacy/preferences</code> in the current folder and change the <code>&quot;keys&quot;</code> property to look like this:</li></ol><pre><code>&quot;keys&quot;:  {
    &quot;azure_key&quot;: &quot;STORAGE ACCOUNT KEY HERE&quot;,
    &quot;password&quot;: &quot;CONFIG PASSWORD HERE&quot;
},
</code></pre><ol start="4"><li>Now you can run <code>duplicacy backup</code> or <code>duplicacy restore</code> from this machine without needing to enter the passwords all the time (note that the passwords are being stored here in plain text, so only do this if you trust no one will compromise the machine).</li></ol><h2 id="3-setup-duplicacy-util">3. Setup duplicacy-util</h2><p>duplicacy-util is another executable that helps schedule backups.</p><ol><li>Similarly as before, grab the <a target="_blank" rel="noopener noreferrer" href="https://github.com/jeffaco/duplicacy-util/releases">latest release</a> of duplicacy-util, run <code>chmod +x</code> on it, and move it to <code>/usr/local/bin</code>.</li><li>Make a <code>.duplicacy-util</code> folder somewhere, e.g. <code>~/.duplicacy-util</code>. Go in there and make 2 files: <code>duplicacy-util.yaml</code> and <code>repository_id.yaml</code> where <code>repository_id</code> is the name you used in step 2.2. This name doesn&#x27;t really matter but it helps to keep things consistent.</li><li>In <code>duplicacy-util.yaml</code>, enter the following:</li></ol><pre><code>notifications:
  onStart: []
  onSkip: [&#x27;email&#x27;]
  onSuccess: [&#x27;email&#x27;]
  onFailure: [&#x27;email&#x27;]

email:
  fromAddress: &quot;Duplicacy Backup &lt;duplicacy@domain.com&gt;&quot;
  toAddress: &quot;Firstname Lastname &lt;someemail@domain.com&gt;&quot;
  serverHostname: smtp.sendgrid.net
  serverPort: 587
  authUsername: apikey
  authPassword: XXX
</code></pre><p>This assumes you&#x27;re using SendGrid, change the email config options as necessary.
4. In <code>repository_id.yaml</code>, enter the following:</p><pre><code>repository: /path/to/folder

storage:
  - name: default
    threads: 1

prune:
  - storage: default
    keep: &quot;0:365 30:180 7:30 1:7&quot;
    threads: 1

check:
  - storage: default
</code></pre><p><code>repository</code> is the folder you initialized duplicacy in, from step 2.2. Read the <a target="_blank" rel="noopener noreferrer" href="https://github.com/jeffaco/duplicacy-util">duplicacy-util docs</a> on the different settings here. Here&#x27;s what the current <code>keep</code> settings mean:</p><pre><code>1:7       # Keep a revision per (1) day for revisions older than 7 days
7:30      # Keep a revision every 7 days for revisions older than 30 days
30:180    # Keep a revision every 30 days for revisions older than 180 days
0:360     # Keep no revisions older than 360 days
</code></pre><p>You can increase the thread count if you have them to improve performance.
5. Finally you need to edit your crontab to run duplicacy-util on some schedule. Run <code>sudo crontab -e</code> to edit the root crontab and add <code>0 5 * * * /usr/local/bin/duplicacy-util -sd /path/to/.duplicacy-util -f repository_id -a -m -q</code>. This will run the job at 5 AM every day, running backup, pruning, and validation of data, with no output to logs, and will send an email.</p></div><a class="obstructed-label" href="/wiki/Code Diary/Scheduled Backups on Ubuntu using Duplicacy and Azure">Scheduled Backups on Ubuntu using Duplicacy and Azure</a></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/Code Diary/Scheduled Backups on Ubuntu using Duplicacy and Azure";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-b26ca15045427b9506aa.js"],"app":["/app-7c974186bb8a4de4930e.js"],"component---node-modules-gatsby-theme-garden-src-templates-local-file-js":["/component---node-modules-gatsby-theme-garden-src-templates-local-file-js-1c8fd98b48ff9516a3fc.js"]};/*]]>*/</script><script src="/wiki/polyfill-b26ca15045427b9506aa.js" nomodule=""></script><script src="/wiki/component---node-modules-gatsby-theme-garden-src-templates-local-file-js-1c8fd98b48ff9516a3fc.js" async=""></script><script src="/wiki/styles-407fe62976dc5310c43e.js" async=""></script><script src="/wiki/app-7c974186bb8a4de4930e.js" async=""></script><script src="/wiki/framework-1ad0fed3c21e97f84900.js" async=""></script><script src="/wiki/webpack-runtime-41aed87232eba2c85fde.js" async=""></script></body></html>